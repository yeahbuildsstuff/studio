<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>InteractiveStudioâ„¢</title>

  <!-- Babylon + Cannon (CDN) -->
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/cannon.js"></script>

  <style>
    body {
      margin: 0;
      background: #f0f0f0;
      color: #222;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #topbar {
      display: flex;
      align-items: center;
      background: #e0e0e0;
      padding: 8px;
      gap: 10px;
      border-bottom: 1px solid #ccc;
    }

    #topbar button {
      padding: 6px 12px;
      background: #ffffff;
      border: 1px solid #aaa;
      color: #222;
      cursor: pointer;
      border-radius: 3px;
    }

    #topbar button:hover {
      background: #f5f5f5;
    }

    #main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    #leftSide {
      flex: 3;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #ccc;
    }

    #viewport {
      flex: 3;
      background: #000;
      position: relative;
    }

    #viewport canvas {
      width: 100%;
      height: 100%;
    }

    #bottomBar {
      height: 24px;
      background: #e0e0e0;
      border-top: 1px solid #ccc;
      font-size: 12px;
      display: flex;
      align-items: center;
      padding-left: 8px;
      color: #555;
    }

    #rightSide {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #f7f7f7;
    }

    #rightTabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      background: #eaeaea;
    }

    #rightTabs button {
      flex: 1;
      padding: 6px;
      border: none;
      border-right: 1px solid #ccc;
      background: #eaeaea;
      cursor: pointer;
      font-size: 13px;
    }

    #rightTabs button.active {
      background: #ffffff;
      font-weight: bold;
    }

    #rightContent {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    #explorer h3,
    #properties h3 {
      margin-top: 0;
      font-size: 14px;
    }

    .folder {
      margin-bottom: 12px;
    }

    .folder strong {
      display: block;
      margin-bottom: 4px;
    }

    .folderContent div {
      padding-left: 10px;
      cursor: pointer;
      padding-top: 2px;
      padding-bottom: 2px;
      font-size: 13px;
    }

    .folderContent div.selected {
      background: #d0e4ff;
    }

    .propRow {
      margin-bottom: 6px;
      font-size: 13px;
    }

    .propRow label {
      display: inline-block;
      width: 80px;
    }

    .propRow input {
      background: #ffffff;
      border: 1px solid #aaa;
      color: #222;
      margin-bottom: 2px;
      width: 80px;
      font-size: 12px;
      padding: 2px;
    }

    .propRow input[type="checkbox"] {
      width: auto;
    }

    .hint {
      font-size: 12px;
      color: #777;
    }
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <div id="topbar">
    <button id="addPartBtn">Part</button>
    <button id="addToolBtn">Tool</button>

    <div style="flex:1"></div>

    <button id="exportBtn">Export</button>
  </div>

  <!-- MAIN AREA -->
  <div id="main">

    <!-- LEFT SIDE -->
    <div id="leftSide">

      <!-- VIEWPORT -->
      <div id="viewport">
        <canvas id="renderCanvas"></canvas>
      </div>

      <!-- BOTTOM STATUS BAR -->
      <div id="bottomBar">
        FreeCam: WASD + mouse drag
      </div>

    </div>

    <!-- RIGHT SIDE -->
    <div id="rightSide">

      <!-- TABS -->
      <div id="rightTabs">
        <button id="tabExplorer" class="active">Explorer</button>
        <button id="tabProperties">Properties</button>
      </div>

      <!-- CONTENT -->
      <div id="rightContent">
        <div id="explorerView">
          <h3>Explorer</h3>

          <div class="folder" id="objectService">
            <strong>ObjectService</strong>
            <div class="folderContent"></div>
          </div>

          <div class="folder" id="toolService">
            <strong>ToolService</strong>
            <div class="folderContent"></div>
          </div>
        </div>

        <div id="propertiesView" style="display:none;">
          <h3>Properties</h3>
          <div id="propContent"></div>
          <div class="hint">Select an object or tool in Explorer.</div>
        </div>
      </div>

    </div>

  </div>

<script>
  // ============================================================
  // DATA MODEL
  // ============================================================
  const ObjectService = [];
  const ToolService = [];
  let selectedObject = null;

  // ============================================================
  // BABYLON SETUP
  // ============================================================
  const canvas = document.getElementById("renderCanvas");
  const engine = new BABYLON.Engine(canvas, true);
  const scene = new BABYLON.Scene(engine);

  const camera = new BABYLON.FreeCamera("cam",
    new BABYLON.Vector3(0, 10, -20),
    scene
  );
  camera.attachControl(canvas, true);
  camera.speed = 0.5;

  // WASD
  camera.keysUp = [87];    // W
  camera.keysDown = [83];  // S
  camera.keysLeft = [65];  // A
  camera.keysRight = [68]; // D

  const light = new BABYLON.HemisphericLight(
    "light",
    new BABYLON.Vector3(0, 1, 0),
    scene
  );

  engine.runRenderLoop(() => scene.render());
  window.addEventListener("resize", () => engine.resize());

  // ============================================================
  // BASEPLATE AS NORMAL PART
  // ============================================================
  function createBaseplate() {
    const base = {
      id: crypto.randomUUID(),
      type: "Part",
      name: "Baseplate",
      color: { r: 0.7, g: 0.7, b: 0.7 },
      position: { x: 0, y: -10, z: 0 },
      size: { x: 64, y: 0.5, z: 64 },
      rotation: { x: 0, y: 0, z: 0 },
      shape: "Block",
      draggable: false,
      mesh: null
    };
    ObjectService.push(base);
    createMeshForPart(base);
  }

  // ============================================================
  // EXPLORER REFRESH
  // ============================================================
  function refreshExplorer() {
    const objFolder = document.querySelector("#objectService .folderContent");
    const toolFolder = document.querySelector("#toolService .folderContent");

    objFolder.innerHTML = "";
    toolFolder.innerHTML = "";

    ObjectService.forEach(obj => {
      const div = document.createElement("div");
      div.textContent = obj.name;
      if (selectedObject === obj) div.classList.add("selected");
      div.onclick = () => selectObject(obj);
      objFolder.appendChild(div);
    });

    ToolService.forEach(tool => {
      const div = document.createElement("div");
      div.textContent = tool.name;
      if (selectedObject === tool) div.classList.add("selected");
      div.onclick = () => selectObject(tool);
      toolFolder.appendChild(div);
    });
  }

  // ============================================================
  // PART & TOOL CREATION
  // ============================================================
  function addPart() {
    const part = {
      id: crypto.randomUUID(),
      type: "Part",
      name: "Part",
      color: { r: 1, g: 1, b: 1 },
      position: { x: 0, y: 1, z: 0 },
      size: { x: 2, y: 2, z: 2 },
      rotation: { x: 0, y: 0, z: 0 },
      shape: "Block",
      draggable: true,
      mesh: null
    };

    ObjectService.push(part);
    createMeshForPart(part);
    refreshExplorer();
  }

  function addTool() {
    const tool = {
      id: crypto.randomUUID(),
      type: "Tool",
      name: "NewTool",
      toolType: "Grab"
    };

    ToolService.push(tool);
    refreshExplorer();
  }

  // ============================================================
  // MESH CREATION / UPDATE
  // ============================================================
  function createMeshForPart(part) {
    let mesh;

    if (part.shape === "Block") {
      mesh = BABYLON.MeshBuilder.CreateBox(part.id, {
        width: part.size.x,
        height: part.size.y,
        depth: part.size.z
      }, scene);
    } else if (part.shape === "Sphere") {
      mesh = BABYLON.MeshBuilder.CreateSphere(part.id, {
        diameter: part.size.x
      }, scene);
    } else if (part.shape === "Cylinder") {
      // Height along X (Roblox-like)
      mesh = BABYLON.MeshBuilder.CreateCylinder(part.id, {
        height: part.size.x,
        diameter: part.size.y
      }, scene);
      mesh.rotation.z = Math.PI / 2;
    } else {
      mesh = BABYLON.MeshBuilder.CreateBox(part.id, {
        width: part.size.x,
        height: part.size.y,
        depth: part.size.z
      }, scene);
    }

    mesh.position = new BABYLON.Vector3(
      part.position.x,
      part.position.y,
      part.position.z
    );

    mesh.rotation.x += part.rotation.x;
    mesh.rotation.y += part.rotation.y;
    mesh.rotation.z += part.rotation.z;

    const mat = new BABYLON.StandardMaterial(part.id + "_mat", scene);
    mat.diffuseColor = new BABYLON.Color3(part.color.r, part.color.g, part.color.b);
    mesh.material = mat;

    part.mesh = mesh;
  }

  function syncPartToMesh(part) {
    if (!part.mesh) return;

    part.mesh.position.set(
      part.position.x,
      part.position.y,
      part.position.z
    );

    // For simplicity, scale relative to base size
    part.mesh.scaling.set(
      part.size.x / 2,
      part.size.y / 2,
      part.size.z / 2
    );

    part.mesh.rotation.set(
      part.rotation.x,
      part.rotation.y,
      part.rotation.z
    );

    part.mesh.material.diffuseColor = new BABYLON.Color3(
      part.color.r,
      part.color.g,
      part.color.b
    );
  }

  // ============================================================
  // SELECTION + PROPERTIES
  // ============================================================
  function selectObject(obj) {
    selectedObject = obj;
    refreshExplorer();
    refreshProperties();
    showPropertiesTab();
  }

  function refreshProperties() {
    const panel = document.getElementById("propContent");
    panel.innerHTML = "";

    if (!selectedObject) {
      panel.innerHTML = "<div class='hint'>Select an object or tool in Explorer.</div>";
      return;
    }

    if (selectedObject.type === "Tool") {
      panel.appendChild(makeInputRow("Name", selectedObject.name, v => {
        selectedObject.name = v;
        refreshExplorer();
      }));

      panel.appendChild(makeInputRow("Type", selectedObject.toolType, v => {
        selectedObject.toolType = v;
      }));
    }

    if (selectedObject.type === "Part") {
      panel.appendChild(makeInputRow("Name", selectedObject.name, v => {
        selectedObject.name = v;
        refreshExplorer();
      }));

      panel.appendChild(makeInputRow("Shape", selectedObject.shape, v => {
        selectedObject.shape = v;
        if (selectedObject.mesh) selectedObject.mesh.dispose();
        createMeshForPart(selectedObject);
      }));

      panel.appendChild(makeCheckboxRow("Draggable", selectedObject.draggable, v => {
        selectedObject.draggable = v;
      }));

      panel.appendChild(makeInputRow("Color R", selectedObject.color.r, v => {
        selectedObject.color.r = parseFloat(v) || 0;
        syncPartToMesh(selectedObject);
      }));
      panel.appendChild(makeInputRow("Color G", selectedObject.color.g, v => {
        selectedObject.color.g = parseFloat(v) || 0;
        syncPartToMesh(selectedObject);
      }));
      panel.appendChild(makeInputRow("Color B", selectedObject.color.b, v => {
        selectedObject.color.b = parseFloat(v) || 0;
        syncPartToMesh(selectedObject);
      }));

      panel.appendChild(makeInputRow("Pos X", selectedObject.position.x, v => {
        selectedObject.position.x = parseFloat(v) || 0;
        syncPartToMesh(selectedObject);
      }));
      panel.appendChild(makeInputRow("Pos Y", selectedObject.position.y, v => {
        selectedObject.position.y = parseFloat(v) || 0;
        syncPartToMesh(selectedObject);
      }));
      panel.appendChild(makeInputRow("Pos Z", selectedObject.position.z, v => {
        selectedObject.position.z = parseFloat(v) || 0;
        syncPartToMesh(selectedObject);
      }));

      panel.appendChild(makeInputRow("Size X", selectedObject.size.x, v => {
        selectedObject.size.x = parseFloat(v) || 1;
        syncPartToMesh(selectedObject);
      }));
      panel.appendChild(makeInputRow("Size Y", selectedObject.size.y, v => {
        selectedObject.size.y = parseFloat(v) || 1;
        syncPartToMesh(selectedObject);
      }));
      panel.appendChild(makeInputRow("Size Z", selectedObject.size.z, v => {
        selectedObject.size.z = parseFloat(v) || 1;
        syncPartToMesh(selectedObject);
      }));

      panel.appendChild(makeInputRow("Rot X", selectedObject.rotation.x, v => {
        selectedObject.rotation.x = parseFloat(v) || 0;
        syncPartToMesh(selectedObject);
      }));
      panel.appendChild(makeInputRow("Rot Y", selectedObject.rotation.y, v => {
        selectedObject.rotation.y = parseFloat(v) || 0;
        syncPartToMesh(selectedObject);
      }));
      panel.appendChild(makeInputRow("Rot Z", selectedObject.rotation.z, v => {
        selectedObject.rotation.z = parseFloat(v) || 0;
        syncPartToMesh(selectedObject);
      }));
    }
  }

  function makeInputRow(labelText, value, onChange) {
    const row = document.createElement("div");
    row.className = "propRow";

    const label = document.createElement("label");
    label.textContent = labelText + ": ";

    const input = document.createElement("input");
    input.value = value;
    input.onchange = () => onChange(input.value);

    row.appendChild(label);
    row.appendChild(input);
    return row;
  }

  function makeCheckboxRow(labelText, value, onChange) {
    const row = document.createElement("div");
    row.className = "propRow";

    const label = document.createElement("label");
    label.textContent = labelText + ": ";

    const input = document.createElement("input");
    input.type = "checkbox";
    input.checked = value;
    input.onchange = () => onChange(input.checked);

    row.appendChild(label);
    row.appendChild(input);
    return row;
  }

  // ============================================================
  // TABS: EXPLORER / PROPERTIES
  // ============================================================
  const tabExplorerBtn = document.getElementById("tabExplorer");
  const tabPropertiesBtn = document.getElementById("tabProperties");
  const explorerView = document.getElementById("explorerView");
  const propertiesView = document.getElementById("propertiesView");

  function showExplorerTab() {
    tabExplorerBtn.classList.add("active");
    tabPropertiesBtn.classList.remove("active");
    explorerView.style.display = "block";
    propertiesView.style.display = "none";
  }

  function showPropertiesTab() {
    tabExplorerBtn.classList.remove("active");
    tabPropertiesBtn.classList.add("active");
    explorerView.style.display = "none";
    propertiesView.style.display = "block";
  }

  tabExplorerBtn.onclick = showExplorerTab;
  tabPropertiesBtn.onclick = showPropertiesTab;

  // ============================================================
  // EXPORTER
  // ============================================================
  async function loadDefaultClient() {
    const res = await fetch("StudioAssets/defaultclient.html");
    return await res.text();
  }

  function generateToolDeclarationsString() {
    if (ToolService.length === 0) {
      return "";
    }
    return ToolService.map(t =>
      `  { type: "${t.toolType}", name: "${t.name}" }`
    ).join(",\n");
  }

  function generatePlaceCodeString() {
    let code = `function PLACE_CODE(scene) {\n\n`;

    ObjectService.forEach((part, index) => {
      if (part.type !== "Part") return;

      const meshName = `part_${index}`;
      const matName = `mat_${index}`;

      if (part.shape === "Block") {
        code += `  const ${meshName} = BABYLON.MeshBuilder.CreateBox("${meshName}", {\n`;
        code += `    width: ${part.size.x},\n`;
        code += `    height: ${part.size.y},\n`;
        code += `    depth: ${part.size.z}\n`;
        code += `  }, scene);\n`;
      } else if (part.shape === "Sphere") {
        code += `  const ${meshName} = BABYLON.MeshBuilder.CreateSphere("${meshName}", {\n`;
        code += `    diameter: ${part.size.x}\n`;
        code += `  }, scene);\n`;
      } else if (part.shape === "Cylinder") {
        code += `  const ${meshName} = BABYLON.MeshBuilder.CreateCylinder("${meshName}", {\n`;
        code += `    height: ${part.size.x},\n`;
        code += `    diameter: ${part.size.y}\n`;
        code += `  }, scene);\n`;
        code += `  ${meshName}.rotation.z = Math.PI / 2;\n`;
      } else {
        code += `  const ${meshName} = BABYLON.MeshBuilder.CreateBox("${meshName}", {\n`;
        code += `    width: ${part.size.x},\n`;
        code += `    height: ${part.size.y},\n`;
        code += `    depth: ${part.size.z}\n`;
        code += `  }, scene);\n`;
      }

      code += `  ${meshName}.position.set(${part.position.x}, ${part.position.y}, ${part.position.z});\n`;
      code += `  ${meshName}.rotation.set(${part.rotation.x}, ${part.rotation.y}, ${part.rotation.z});\n`;

      code += `  const ${matName} = new BABYLON.StandardMaterial("${matName}", scene);\n`;
      code += `  ${matName}.diffuseColor = new BABYLON.Color3(${part.color.r}, ${part.color.g}, ${part.color.b});\n`;
      code += `  ${meshName}.material = ${matName};\n`;

      if (part.draggable) {
        code += `  if (makeDraggableRef) { makeDraggableRef(${meshName}); }\n`;
      }

      code += `\n`;
    });

    code += `}\n`;
    return code;
  }

  function applyExporterMods(html) {
    // 1) toolDeclarations
    const toolStart = html.indexOf("const toolDeclarations");
    if (toolStart !== -1) {
      const toolOpen = html.indexOf("[", toolStart);
      const toolClose = html.indexOf("]", toolOpen);
      const toolsStr = generateToolDeclarationsString();
      const newToolsBlock = toolsStr ? "\n" + toolsStr + "\n" : "\n";
      html =
        html.substring(0, toolOpen + 1) +
        newToolsBlock +
        html.substring(toolClose);
    }

    // 2) PLACE_CODE(scene)
    const placeStart = html.indexOf("function PLACE_CODE(scene)");
    if (placeStart !== -1) {
      const braceOpen = html.indexOf("{", placeStart);
      let depth = 1;
      let i = braceOpen + 1;
      while (i < html.length && depth > 0) {
        if (html[i] === "{") depth++;
        if (html[i] === "}") depth--;
        i++;
      }
      const braceClose = i;
      const newPlaceCode = generatePlaceCodeString();
      html =
        html.substring(0, placeStart) +
        newPlaceCode +
        html.substring(braceClose);
    }

    return html;
  }

  function downloadClient(html) {
    const blob = new Blob([html], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "InteractiveClient.html";
    a.click();
    URL.revokeObjectURL(url);
  }

  async function exportClient() {
    let html = await loadDefaultClient();
    html = applyExporterMods(html);
    downloadClient(html);
  }

  // ============================================================
  // HOOK UP BUTTONS + INIT
  // ============================================================
  document.getElementById("addPartBtn").onclick = addPart;
  document.getElementById("addToolBtn").onclick = addTool;
  document.getElementById("exportBtn").onclick = exportClient;

  createBaseplate();
  refreshExplorer();
  refreshProperties();

</script>

</body>
</html>
